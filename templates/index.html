<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterTime - 时间管理大师</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { scroll-behavior: smooth; }
        
        /* 响应式日历网格 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 600px;
        }
        
        .day-cell {
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-height: 80px; /* 手机端点击区域高度 */
        }
        
        .day-cell:hover { background-color: #f9fafb; }
        
        /* 手机端适配 */
        @media (max-width: 768px) {
            .day-cell {
                padding: 12px; /* 增加内边距，提升触摸体验 */
            }
            .holiday-label {
                font-size: 9px; top: 4px; right: 4px; /* 调整节假日标签 */
            }
        }

        .holiday-label {
            font-size: 10px; color: #ef4444; position: absolute;
            top: 2px; right: 4px; font-weight: bold;
        }
        
        .priority-dot {
            width: 8px; height: 8px; border-radius: 50%;
            display: inline-block; margin-right: 4px;
        }
        .p1 { background-color: #ef4444; }
        .p2 { background-color: #f59e0b; }
        .p3 { background-color: #3b82f6; }
        
        /* 悬浮窗响应式 */
        #hover-popup {
            display: none; position: fixed; z-index: 100;
            background: white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem; border: 1px solid #e5e7eb;
            min-width: 240px; max-width: 90vw; /* 移动端最大宽度 */
            padding: 14px; pointer-events: auto;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast 动画 */
        @keyframes toastSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: toastSlide 0.3s ease-out; }
        
        @keyframes fadeOutTimer {
            from { opacity: 1; }
            to { opacity: 0.2; }
        }
        .timer-fading { animation: fadeOutTimer 5s linear forwards; }
    </style>
</head>
<body class="bg-gray-50 font-sans overflow-x-hidden">

    <!-- Header -->
    <header class="bg-white border-b h-20 flex items-center justify-between px-4 sm:px-6 shadow-sm z-10 sticky top-0">
        <div class="flex items-center gap-2 sm:gap-6">
            <h1 class="text-xl sm:text-2xl font-extrabold text-indigo-600 flex items-center gap-1 sm:gap-2">
                <i class="fas fa-calendar-check text-sm sm:text-xl"></i> <span class="hidden sm:inline">MasterTime</span>
            </h1>
            <div class="flex items-center bg-gray-100 rounded-xl p-1 shadow-inner">
                <button id="prevMonth" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center hover:bg-white rounded-lg transition-all">
                    <i class="fas fa-chevron-left text-gray-500 text-sm sm:text-base"></i>
                </button>
                <span id="currentMonthYear" class="px-2 sm:px-6 font-bold text-gray-700 text-xs sm:text-sm min-w-[60px] sm:min-w-[140px] text-center"></span>
                <button id="nextMonth" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center hover:bg-white rounded-lg transition-all">
                    <i class="fas fa-chevron-right text-gray-500 text-sm sm:text-base"></i>
                </button>
            </div>
            <button id="todayBtn" class="bg-indigo-50 text-indigo-600 px-2 sm:px-5 py-2 rounded-xl font-bold hover:bg-indigo-100 transition-colors shadow-sm active:scale-95 text-xs sm:text-sm">
                今天
            </button>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
            <a href="#event-list-section" class="text-gray-500 hover:text-indigo-600 font-bold flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 sm:py-2 transition-colors text-xs sm:text-sm">
                <i class="fas fa-list-ul"></i> <span class="hidden sm:inline">事务清单</span>
            </a>
            <button onclick="openAIModal()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-2 sm:px-6 py-1.5 sm:py-2.5 rounded-full shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-1 sm:gap-2 font-bold text-xs sm:text-sm">
                <i class="fas fa-wand-magic-sparkles"></i> <span class="hidden sm:inline">AI 快速记事</span>
            </button>
        </div>
    </header>

    <!-- Calendar View -->
    <main id="calendar" class="calendar-grid text-xs sm:text-sm"></main>

    <!-- Event List View -->
    <section id="event-list-section" class="max-w-6xl mx-auto py-12 sm:py-16 px-4 sm:px-6">
        <div class="flex justify-between items-center mb-4 sm:mb-8">
            <h2 class="text-xl sm:text-3xl font-black text-gray-900">事务总览清单</h2>
            <div class="text-xs sm:text-sm text-gray-500 font-bold bg-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full shadow-sm border">共 <span id="total-event-count" class="text-indigo-600">0</span> 项事务</div>
        </div>
        <div id="full-event-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
        <div id="empty-state" class="hidden text-center py-12 sm:py-20 bg-white rounded-3xl border-2 border-dashed border-gray-200">
            <div class="text-3xl sm:text-6xl mb-2 sm:mb-4 text-gray-200"><i class="fas fa-calendar-plus"></i></div>
            <p class="text-gray-400 font-bold text-xs sm:text-sm sm:text-base">暂时没有安排任何事项</p>
        </div>
    </section>

    <!-- Hover Popup -->
    <div id="hover-popup">
        <div class="flex justify-between items-center mb-2 sm:mb-3 border-b pb-2">
            <div id="popup-date" class="font-bold text-gray-900 text-xs sm:text-sm"></div>
            <button onclick="closePopup()" class="text-gray-300 hover:text-gray-500 text-base sm:text-lg"><i class="fas fa-times"></i></button>
        </div>
        <div id="popup-events" class="space-y-1 sm:space-y-2 mb-3 sm:mb-4 max-h-40 sm:max-h-56 overflow-y-auto scrollbar-hide"></div>
        <button onclick="showManualAdd()" class="w-full bg-indigo-600 text-white py-2 sm:py-2.5 rounded-xl text-[10px] sm:text-xs font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-1 sm:gap-2 shadow-md">
            <i class="fas fa-plus"></i> 新建事项
        </button>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 sm:p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-2xl font-black text-gray-800 flex items-center gap-2 sm:gap-3">
                    <span class="p-1.5 sm:p-2 bg-indigo-100 rounded-lg text-indigo-600 text-sm sm:text-base"><i class="fas fa-robot"></i></span>
                    <span>AI 智能提取</span>
                </h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600 text-base sm:text-xl"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-gray-500 mb-3 sm:mb-4 text-xs sm:text-sm">描述你想做的事，AI 会自动识别日期、任务和优先级。</p>
            <textarea id="ai-input" rows="4" class="w-full border-2 border-gray-100 rounded-2xl p-3 sm:p-4 focus:border-indigo-500 focus:ring-0 outline-none resize-none transition-colors text-sm sm:text-base" placeholder="例如：明天下午三点和张总开会，非常重要..."></textarea>
            <div class="mt-4 sm:mt-6">
                <button id="ai-submit" onclick="submitAI()" class="w-full bg-indigo-600 text-white py-3 sm:py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 text-sm sm:text-lg">
                    <i class="fas fa-bolt"></i> 立即解析并创建
                </button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="add-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 sm:p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-2xl font-black text-gray-800 flex items-center gap-2 sm:gap-3">
                    <span class="p-1.5 sm:p-2 bg-indigo-100 rounded-lg text-indigo-600 text-sm sm:text-base"><i class="fas fa-plus"></i></span>
                    <span>新建事项</span>
                </h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600 text-base sm:text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <label class="text-xs sm:text-sm font-bold text-gray-600 mb-2 block">事项内容</label>
                <input type="text" id="event-title" onkeypress="if(event.key==='Enter')submitAddEvent()" class="w-full border-2 border-gray-100 rounded-2xl p-3 sm:p-4 focus:border-indigo-500 focus:ring-0 outline-none transition-colors text-sm sm:text-base" placeholder="输入事项内容...">
            </div>
            <div class="mb-4 sm:mb-6">
                <label class="text-xs sm:text-sm font-bold text-gray-600 mb-2 block">优先级</label>
                <div class="flex gap-2">
                    <button onclick="selectPriority(1)" id="priority-1" class="flex-1 py-2 sm:py-3 rounded-xl border-2 border-gray-100 font-bold text-sm sm:text-base transition-colors hover:border-red-500 text-gray-600">
                        P1 紧急
                    </button>
                    <button onclick="selectPriority(2)" id="priority-2" class="flex-1 py-2 sm:py-3 rounded-xl border-2 border-indigo-500 bg-indigo-50 font-bold text-sm sm:text-base transition-colors text-indigo-600">
                        P2 普通
                    </button>
                    <button onclick="selectPriority(3)" id="priority-3" class="flex-1 py-2 sm:py-3 rounded-xl border-2 border-gray-100 font-bold text-sm sm:text-base transition-colors hover:border-blue-500 text-gray-600">
                        P3 低
                    </button>
                </div>
            </div>
            <div>
                <button onclick="submitAddEvent()" class="w-full bg-indigo-600 text-white py-3 sm:py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 text-sm sm:text-lg">
                    <i class="fas fa-check"></i> 确认创建
                </button>
            </div>
        </div>
    </div>

    <!-- Undo Toast Container -->
    <div id="undo-container" class="fixed bottom-6 sm:bottom-10 right-4 sm:right-10 z-[100] flex flex-col gap-2 sm:gap-3"></div>

    <script>
        let currentDate = new Date();
        let events = {};
        let pendingDeletes = new Map();
        let selectedPriority = 2;
        
        const holidays = {
            "2026-01-01": "元旦", "2026-01-02": "元旦", "2026-01-03": "元旦",
            "2026-02-16": "春节", "2026-02-17": "春节", "2026-02-18": "春节", "2026-02-19": "春节", "2026-02-20": "春节",
            "2026-02-21": "春节", "2026-02-22": "春节", "2026-02-23": "春节",
            "2026-04-04": "清明节", "2026-04-05": "清明节", "2026-04-06": "清明节",
            "2026-05-01": "劳动节", "2026-05-02": "劳动节", "2026-05-03": "劳动节", "2026-05-04": "劳动节", "2026-05-05": "劳动节",
            "2026-06-19": "端午节", "2026-06-20": "端午节", "2026-06-21": "端午节",
            "2026-09-25": "中秋节", "2026-09-26": "中秋节", "2026-09-27": "中秋节",
            "2026-10-01": "国庆节", "2026-10-02": "国庆节", "2026-10-03": "国庆节", "2026-10-04": "国庆节", "2026-10-05": "国庆节", "2026-10-06": "国庆节", "2026-10-07": "国庆节"
        };

        async function fetchEvents() {
            try {
                const res = await fetch('/api/events');
                events = await res.json();
                renderCalendar();
                renderEventList();
            } catch (e) { console.error(e); }
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            days.forEach(day => {
                const h = document.createElement('div');
                h.className = 'bg-white text-center py-1 sm:py-3 font-black text-indigo-600 border-b border-gray-100 text-[10px] sm:text-xs leading-none flex items-center justify-center sticky top-[80px] z-10';
                h.innerText = day; calendar.appendChild(h);
            });
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            document.getElementById('currentMonthYear').innerText = `${year}年 ${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = document.createElement('div'); cell.className = 'day-cell bg-gray-50/50 p-2 text-gray-300';
                cell.innerHTML = `<span>${prevMonthDays - i}</span>`; calendar.appendChild(cell);
            }
            const todayStr = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;
            for (let d = 1; d <= daysInMonth; d++) {
                const dayCell = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                dayCell.className = `day-cell p-2 flex flex-col ${isToday ? 'bg-indigo-50/40' : 'bg-white'}`;
                dayCell.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="font-bold ${isToday ? 'bg-indigo-600 text-white w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center rounded-full -mt-0.5 -ml-0.5 shadow-md' : 'text-gray-700'}">${d}</span>${holidays[dateStr] ? `<span class="holiday-label">${holidays[dateStr]}</span>` : ''}</div>`;
                if (events[dateStr]) {
                    const ec = document.createElement('div'); ec.className = 'space-y-1 overflow-hidden';
                    events[dateStr].slice(0, 3).forEach(ev => {
                        const ed = document.createElement('div');
                        ed.className = `text-[9px] sm:text-[10px] truncate py-0.5 px-1 sm:px-2 rounded-md bg-opacity-10 border-l-2 font-bold ${ev.priority==1?'bg-red-500 border-red-500 text-red-700':(ev.priority==2?'bg-amber-500 border-amber-500 text-amber-700':'bg-blue-500 border-blue-500 text-blue-700')}`;
                        ed.innerText = ev.title; ec.appendChild(ed);
                    });
                    if (events[dateStr].length > 3) ec.innerHTML += `<div class="text-[8px] sm:text-[9px] text-gray-400 font-bold pl-0.5 sm:pl-1">+${events[dateStr].length-3} 更多...</div>`;
                    dayCell.appendChild(ec);
                }
                dayCell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPopup(e, dateStr, dayCell);
                });
                
                dayCell.addEventListener('mouseenter', (e) => {
                    showPopup(e, dateStr, dayCell);
                });
                
                dayCell.addEventListener('mouseleave', (e) => {
                    if (!e.relatedTarget || !e.relatedTarget.closest('#hover-popup')) {
                        hidePopup();
                    }
                });
                calendar.appendChild(dayCell);
            }
        }

        function renderEventList() {
            const list = document.getElementById('full-event-list'), count = document.getElementById('total-event-count');
            list.innerHTML = ''; let all = [];
            Object.keys(events).sort().forEach(date => { events[date].forEach(ev => all.push({...ev, date})); });
            count.innerText = all.length;
            if (all.length === 0) { document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');
            all.forEach(ev => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 sm:p-6 rounded-3xl border border-gray-100 shadow-sm relative group';
                const pColor = ev.priority == 1 ? 'red' : (ev.priority == 2 ? 'amber' : 'blue');
                card.innerHTML = `<div class="flex justify-between items-start mb-3 sm:mb-4"><span class="text-[10px] sm:text-xs font-black text-gray-400">${ev.date}</span><span class="bg-${pColor}-100 text-${pColor}-600 text-[10px] font-black px-1.5 sm:px-2 py-1 rounded-lg">P${ev.priority}</span></div><h4 class="text-base sm:text-lg font-bold text-gray-800 mb-3 sm:mb-4">${ev.title}</h4><button onclick="handleDelete('${ev.date}', ${ev.id})" class="absolute top-3 sm:top-4 right-3 sm:right-4 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(card);
            });
        }

        const popup = document.getElementById('hover-popup');
        let activeDate = '', popupHideTimeout;
        
        function showPopup(e, dateStr, clickedElement) {
            clearTimeout(popupHideTimeout); activeDate = dateStr;
            const pd = document.getElementById('popup-date'), pe = document.getElementById('popup-events');
            pd.innerText = dateStr; pe.innerHTML = '';
            if (events[dateStr]) {
                events[dateStr].forEach(ev => {
                    const item = document.createElement('div');
                    item.className = 'text-xs sm:text-sm text-gray-700 flex justify-between items-center p-2 sm:p-3 rounded-xl bg-gray-50 border border-gray-100 group';
                    item.innerHTML = `<div class="flex items-center gap-1 sm:gap-2 overflow-hidden"><span class="priority-dot p${ev.priority}"></span><span class="truncate">${ev.title}</span></div><button onclick="handleDelete('${dateStr}', ${ev.id})" class="text-gray-300 hover:text-red-500 pl-1 sm:pl-2 opacity-0 group-hover:opacity-100"><i class="fas fa-times-circle"></i></button>`;
                    pe.appendChild(item);
                });
            } else pe.innerHTML = '<div class="text-xs text-gray-400 italic py-4 sm:py-6 text-center">今日暂无安排</div>';
            popup.style.display = 'block';
            
            const rect = clickedElement.getBoundingClientRect();
            let x = rect.left;
            let y = rect.bottom + 10;
            
            if (x + 260 > window.innerWidth) x = window.innerWidth - 270;
            if (y + 300 > window.innerHeight) y = window.innerHeight - 310;
            
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
        }

        function hidePopup() { popupHideTimeout = setTimeout(() => { if (!popup.matches(':hover')) popup.style.display = 'none'; }, 100); }
        function closePopup() { popup.style.display = 'none'; }
        popup.onmouseenter = () => clearTimeout(popupHideTimeout);
        popup.onmouseleave = () => popup.style.display = 'none';

        // Enhanced Delete Logic with Undo
        function handleDelete(date, id) {
            const eventIndex = events[date].findIndex(e => e.id === id);
            if (eventIndex === -1) return;
            const event = events[date][eventIndex];
            
            events[date].splice(eventIndex, 1);
            if (events[date].length === 0) delete events[date];
            renderCalendar(); renderEventList(); closePopup();

            const toastId = Date.now();
            const toast = document.createElement('div');
            toast.id = `undo-${toastId}`;
            toast.className = 'toast-enter bg-gray-900 text-white px-4 sm:px-6 py-3 sm:py-4 rounded-2xl shadow-2xl flex items-center justify-between gap-4 sm:gap-6 min-w-[200px] sm:min-w-[280px]';
            toast.innerHTML = `
                <div class="flex flex-col">
                    <span class="text-[10px] sm:text-[10px] text-gray-400 font-black uppercase tracking-widest">已移除</span>
                    <span class="text-xs sm:text-sm font-bold truncate max-w-[120px] sm:max-w-[150px]">${event.title}</span>
                </div>
                <button onclick="undoDelete(${toastId}, '${date}', ${JSON.stringify(event).replace(/"/g, '&quot;')})" 
                        class="timer-fading bg-indigo-600 hover:bg-indigo-500 text-[10px] font-black px-3 sm:px-4 py-1.5 sm:py-2 rounded-xl transition-colors">
                    恢复
                </button>
            `;
            document.getElementById('undo-container').appendChild(toast);

            const timer = setTimeout(async () => {
                await fetch('/api/delete_event', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({date, id})
                });
                toast.classList.add('opacity-0', 'translate-x-10', 'transition-all', 'duration-500');
                setTimeout(() => toast.remove(), 500);
            }, 5000);

            pendingDeletes.set(toastId, timer);
        }

        function undoDelete(toastId, date, eventObj) {
            const timer = pendingDeletes.get(toastId);
            if (timer) {
                clearTimeout(timer);
                pendingDeletes.delete(toastId);
                if (!events[date]) events[date] = [];
                events[date].push(eventObj);
                renderCalendar(); renderEventList();
                document.getElementById(`undo-${toastId}`).remove();
            }
        }

        async function addEvent(date, title, priority) {
            await fetch('/api/add_event', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date, title, priority: parseInt(priority) || 3})
            });
            fetchEvents();
        }

        function showManualAdd() {
            closePopup();
            selectedPriority = 2;
            selectPriority(2);
            document.getElementById('event-title').value = '';
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('event-title').focus();
        }

        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

        function selectPriority(p) {
            selectedPriority = p;
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`priority-${i}`);
                if (i === p) {
                    btn.className = `flex-1 py-2 sm:py-3 rounded-xl border-2 font-bold text-sm sm:text-base transition-colors ${i===1?'border-red-500 bg-red-50 text-red-600':(i===2?'border-indigo-500 bg-indigo-50 text-indigo-600':'border-blue-500 bg-blue-50 text-blue-600')}`;
                } else {
                    btn.className = 'flex-1 py-2 sm:py-3 rounded-xl border-2 border-gray-100 font-bold text-sm sm:text-base transition-colors hover:border-gray-300 text-gray-600';
                }
            }
        }

        async function submitAddEvent() {
            const title = document.getElementById('event-title').value.trim();
            if (!title) {
                alert('请输入事项内容');
                return;
            }
            await addEvent(activeDate, title, selectedPriority);
            closeAddModal();
        }

        function openAIModal() { document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-input').focus(); }
        function closeAIModal() { document.getElementById('ai-modal').classList.add('hidden'); }

        async function submitAI() {
            const btn = document.getElementById('ai-submit'), input = document.getElementById('ai-input');
            if (!input.value) return;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            try {
                const res = await fetch('/api/ai_parse', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: input.value}) });
                const r = await res.json();
                if (r.title) { await addEvent(r.date, r.title, r.priority); closeAIModal(); input.value = ''; }
            } catch (err) { alert("AI解析异常"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-bolt"></i> 立即解析并创建'; }
        }

        document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
        document.getElementById('todayBtn').onclick = () => { currentDate = new Date(); renderCalendar(); };
        
        document.addEventListener('click', (e) => {
            if (e.target.id === 'ai-modal') closeAIModal();
            const popupEl = document.getElementById('hover-popup');
            if (!e.target.closest('.day-cell') && !e.target.closest('#hover-popup')) {
                popupEl.style.display = 'none';
            }
        });

        fetchEvents();
    </script>
</body>
</html>
